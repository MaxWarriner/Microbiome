sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
# Add annotations per facet
p <- p + geom_text(
data = annotations,
aes(x = 1.5, y = y, label = label),
inherit.aes = FALSE,
size = 10,
)
# scale_x_discrete(labels = c("never", "sometimes", "always"))
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}
create_a_diversity_plot <- function(ps, variable, alpha_level = 0.05) {
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
# Convert sample data to data frame
sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
# Add annotations per facet
p <- p + geom_text(
data = annotations,
aes(y = y, label = label),
inherit.aes = FALSE,
size = 10,
)
# scale_x_discrete(labels = c("never", "sometimes", "always"))
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}
create_a_diversity_plot <- function(ps, variable, alpha_level = 0.05) {
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
# Convert sample data to data frame
sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
# Add annotations per facet
p <- p + geom_text(
data = annotations,
aes(y = y, label = label),
x = Inf,              # automatically use rightmost x
inherit.aes = FALSE,
hjust = 0.5,          # center horizontally
size = 10
)
# scale_x_discrete(labels = c("never", "sometimes", "always"))
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}
create_a_diversity_plot <- function(ps, variable, alpha_level = 0.05) {
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
# Convert sample data to data frame
sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
annotations <- annotations %>%
rowwise() %>%
mutate(
x = {
levels <- levels(factor(long_data[[variable]][long_data$Measure == Measure]))
levels[ceiling(length(levels)/2)]
}
)
# Add geom_text with x = middle factor level
p <- p + geom_text(
data = annotations,
aes(x = x, y = y, label = label),
inherit.aes = FALSE,
size = 10
)
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}
create_a_diversity_plot <- function(ps, variable, alpha_level = 0.05) {
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
# Convert sample data to data frame
sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
annotations$x <- sapply(annotations$Measure, function(m) {
length(unique(long_data[[variable]][long_data$Measure == m])) / 2
})
# Add the text to the plot
p <- p + geom_text(
data = annotations,
aes(x = x, y = y, label = label),
inherit.aes = FALSE,
size = 10
)
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}
create_a_diversity_plot <- function(ps, variable, alpha_level = 0.05) {
library(phyloseq)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
# Convert sample data to data frame
sam_data <- as(sample_data(ps), "data.frame")
# Remove NAs
keep_samples <- !is.na(sam_data[[variable]])
ps_filtered <- prune_samples(keep_samples, ps)
sam_data_filtered <- as(sample_data(ps_filtered), "data.frame")
# Keep groups with at least 5 samples
value_counts <- table(sam_data_filtered[[variable]])
valid_values <- names(value_counts)[value_counts >= 5]
final_keep_samples <- sam_data_filtered[[variable]] %in% valid_values
ps_final <- prune_samples(final_keep_samples, ps_filtered)
sam_data_final <- as(sample_data(ps_final), "data.frame")
# Compute diversity metrics
alpha_div <- estimate_richness(ps_final, measures = c("Chao1", "Shannon"))
sam_data_final$Chao1 <- alpha_div$Chao1
sam_data_final$Shannon <- alpha_div$Shannon
# Function to calculate effect size (eta squared)
kruskal_eta_sq <- function(formula, data) {
test <- kruskal.test(formula, data = data)
H <- test$statistic
k <- length(unique(data[[all.vars(formula)[2]]]))
n <- nrow(data)
eta_sq <- (H - k + 1) / (n - k)
list(statistic = H, p = test$p.value, eta_sq = eta_sq)
}
# Run significance tests
chao_res <- kruskal_eta_sq(as.formula(paste("Chao1 ~", variable)), sam_data_final)
shan_res <- kruskal_eta_sq(as.formula(paste("Shannon ~", variable)), sam_data_final)
if (chao_res$p < alpha_level | shan_res$p < alpha_level) {
message(sprintf("Significant results for '%s' (Chao1 p=%.4f, η²=%.3f; Shannon p=%.4f, η²=%.3f)",
variable, chao_res$p, chao_res$eta_sq, shan_res$p, shan_res$eta_sq))
# Reshape data into long format
long_data <- sam_data_final %>%
dplyr::select(all_of(variable), Chao1, Shannon) %>%
pivot_longer(cols = c("Chao1", "Shannon"), names_to = "Measure", values_to = "Value")
# Add p-values and eta squared for each measure
annotations <- data.frame(
Measure = c("Chao1", "Shannon"),
label = c(
sprintf("p=%.4f, η²=%.3f", chao_res$p, chao_res$eta_sq),
sprintf("p=%.4f, η²=%.3f", shan_res$p, shan_res$eta_sq)
),
y = c(max(long_data$Value[long_data$Measure=="Chao1"]) * 1.05,
max(long_data$Value[long_data$Measure=="Shannon"]) * 1.05)
)
# Plot
p <- ggplot(long_data, aes_string(x = variable, y = "Value", color = variable)) +
geom_boxplot() +
geom_jitter(alpha = 0.25, width = 0.1) +
facet_wrap(~Measure, scales = "free_y") +
theme_bw() +
theme(axis.text = element_text(size = 12),
axis.title = element_text(size = 18, face = "bold"),
legend.position = "none",
axis.text.x = element_text(size = 14)) +
labs(x = gsub("_", " ", variable))
# Automatically center based on numeric positions of factor levels
annotations$x <- sapply(annotations$Measure, function(m) {
groups <- unique(long_data[[variable]][long_data$Measure == m])
mean(as.numeric(factor(groups, levels = unique(long_data[[variable]]))))
})
# Add the text
p <- p + geom_text(
data = annotations,
aes(x = x, y = y, label = label),
inherit.aes = FALSE,
size = 10
)
# Save plot if directory specified
ggsave(filename = paste0(variable, "_diversity_plot.png"),
plot = p, width = 12, height = 6, dpi = 300)
return(p)
} else {
message(sprintf("No significant difference for '%s' (Chao1 p=%.4f, Shannon p=%.4f) — skipped.",
variable, chao_res$p, shan_res$p))
return(NULL)
}
}
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/alpha diversity boxplots/Significant Plots")
for(factor in colnames(sam)){
try(create_a_diversity_plot(ps, factor))
}

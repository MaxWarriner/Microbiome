pval_jaccard <- permanova_jaccard$`Pr(>F)`[1]
pval_bray <- permanova_bray$`Pr(>F)`[1]
p_text_jaccard <- ifelse(pval_jaccard < 0.001, "p < 0.001",
paste("p =", format(round(pval_jaccard, 3), nsmall = 3)))
p_text_bray <- ifelse(pval_bray < 0.001, "p < 0.001",
paste("p =", format(round(pval_bray, 3), nsmall = 3)))
pcoa_jaccard_plot <- ggordpoint(obj = jaccard_pcoa, biplot = FALSE, speciesannot = TRUE,
factorNames = c(variable), ellipse = TRUE, linesize = 1.5,
ellipse_linewd = 1, ellipse_lty = 2) +
ggtitle(paste(gsub("_", " ", variable), "(Jaccard)")) +
guides(color=guide_legend(title=gsub("_", " ", variable), override.aes = list(size = 4))) +
theme(legend.title = element_blank(), legend.text = element_text(size = 20)) +
annotate("text", x = Inf, y = Inf, label = p_text_jaccard,
hjust = 1.1, vjust = 1.5, size = 12, fontface = "bold")
pcoa_bray_plot <- ggordpoint(obj = bray_pcoa, biplot = FALSE, speciesannot = TRUE,
factorNames = c(variable), ellipse = TRUE, linesize = 1.5,
ellipse_linewd = 1, ellipse_lty = 2) +
ggtitle(paste(gsub("_", " ", variable), "(Bray-Curtis)")) +
guides(color=guide_legend(title=gsub("_", " ", variable), override.aes = list(size = 4))) +
theme(legend.title = element_blank(), legend.text = element_text(size = 20)) +
annotate("text", x = Inf, y = Inf, label = p_text_bray,
hjust = 1.1, vjust = 1.5, size = 12, fontface = "bold")
combined_plot <- pcoa_jaccard_plot + pcoa_bray_plot
ggsave(combined_plot,
filename = paste(variable, "_pcoa_combined.png", sep = ""),
device = "png",
height = 6, width = 14, units = "in")
return(combined_plot)
}
setwd("C:/Users/12697/Documents/MATH481_Max_Alta/Figures/Beta Diversity/Microbiome")
for (i in 1:length(sig)){
create_pcoa_plot(sig[i], jaccard, bray, jaccard_pcoa, bray_pcoa, sam)
}
View(permanova_jaccard)
permanova_bray <- vegan::adonis2(bray ~ calories_group + nutrient_score, data = food, by = "margin")
View(permanova_bray)
# Load packages
library(vegan)
library(ggplot2)
library(patchwork)
library(tibble)
library(dplyr)
setwd("C:/Users/12697/Documents/MATH481_Max_Alta/Standard Microbiome Analysis")
ps <- readRDS('microbiome.RDS')
sam <- ps@sam_data
food <- sam[,c(180:209, 213, 215)]
metabolite_data <- read_csv('metabolites_transposed.csv') |>
column_to_rownames('...1')
bray <- vegan::vegdist(metabolite_data, method = "bray")
jaccard <- vegan::vegdist(metabolite_data, method = "jaccard")
View(food)
# PERMANOVA for each metadata variable
bdiv <- tibble(
variable = colnames(food)[-1],
jaccard_p = NA_real_,
bray_p = NA_real_
)
View(bdiv)
# PERMANOVA for each metadata variable
bdiv <- tibble(
variable = colnames(food)[-32],
jaccard_p = NA_real_,
bray_p = NA_real_
)
i = 1
variable = bdiv$nutrient[i]
variable = bdiv$variable[i]
bray_formula <- as.formula(paste("bray ~ calories_group + ", variable, sep = ""))
permanova_bray <- vegan::adonis2(bray_formula, data = food, by = "margin")
View(food)
food <- data.frame(sam[,c(180:209, 213, 215)])
permanova_bray <- vegan::adonis2(bray_formula, data = food, by = "margin")
View(permanova_bray)
for (i in seq_along(colnames(food))) {
variable = bdiv$variable[i]
bray_formula <- as.formula(paste("bray ~ calories_group + ", variable, sep = ""))
permanova_bray <- vegan::adonis2(bray_formula, data = food, by = "margin")
bdiv$bray_p[i] <- permanova_bray$`Pr(>F)`[2]
jaccard_formula <- as.formula(paste("jaccard ~ calories_group + ", variable, sep = ""))
permanova_jaccard <- vegan::adonis2(jaccard_formula, data = food, by = "margin")
bdiv$jaccard_p[i] <- permanova_jaccard$`Pr(>F)`[2]
}
for (i in seq_along(colnames(food)[-32])) {
variable = bdiv$variable[i]
bray_formula <- as.formula(paste("bray ~ calories_group + ", variable, sep = ""))
permanova_bray <- vegan::adonis2(bray_formula, data = food, by = "margin")
bdiv$bray_p[i] <- permanova_bray$`Pr(>F)`[2]
jaccard_formula <- as.formula(paste("jaccard ~ calories_group + ", variable, sep = ""))
permanova_jaccard <- vegan::adonis2(jaccard_formula, data = food, by = "margin")
bdiv$jaccard_p[i] <- permanova_jaccard$`Pr(>F)`[2]
}
# Adjust p-values
bdiv <- bdiv %>%
mutate(
adjusted_bray = p.adjust(bray_p, method = "BH"),
adjusted_jaccard = p.adjust(jaccard_p, method = "BH")
)
sig_vars <- bdiv %>%
filter(bray_p <= 0.1 & jaccard_p <= 0.1) %>%
pull(variable)
# -------------------------------------------------------------------------
# Ordinations
# -------------------------------------------------------------------------
bray_pcoa <- cmdscale(bray, eig = TRUE, k = 2)
jaccard_pcoa <- cmdscale(jaccard, eig = TRUE, k = 2)
bray_var <- round(100 * bray_pcoa$eig / sum(bray_pcoa$eig), 1)
jaccard_var <- round(100 * jaccard_pcoa$eig / sum(jaccard_pcoa$eig), 1)
extract_scores <- function(pcoa_obj) {
as.data.frame(pcoa_obj$points) %>%
rename(Axis1 = V1, Axis2 = V2)
}
bray_scores <- extract_scores(bray_pcoa)
jaccard_scores <- extract_scores(jaccard_pcoa)
bray_scores <- cbind(bray_scores, food)
jaccard_scores <- cbind(jaccard_scores, food)
# -------------------------------------------------------------------------
# Function for plotting ordination with 95% ellipses
# -------------------------------------------------------------------------
create_pcoa_plot <- function(variable, bray_scores, jaccard_scores) {
# Force factor for grouping
bray_scores[[variable]] <- as.factor(bray_scores[[variable]])
jaccard_scores[[variable]] <- as.factor(jaccard_scores[[variable]])
# p-values
permanova_bray <- vegan::adonis2(bray ~ food[[variable]])
permanova_jaccard <- vegan::adonis2(jaccard ~ food[[variable]])
p_bray <- permanova_bray$`Pr(>F)`[1]
p_jaccard <- permanova_jaccard$`Pr(>F)`[1]
p_text_bray <- ifelse(p_bray < 0.001, "p < 0.001", paste0("p = ", signif(p_bray, 3)))
p_text_jaccard <- ifelse(p_jaccard < 0.001, "p < 0.001", paste0("p = ", signif(p_jaccard, 3)))
# Bray–Curtis PCoA
p_bray_plot <- ggplot(bray_scores, aes(x = Axis1, y = Axis2, color = .data[[variable]])) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(
aes(group = .data[[variable]]),
geom = "path",
linetype = "dotted",
linewidth = 1,
alpha = 0.9,
type = "t",
level = 0.95
) +
labs(
title = paste(variable, "(Bray–Curtis)"),
subtitle = p_text_bray,
x = paste0("PCoA1 (", bray_var[1], "%)"),
y = paste0("PCoA2 (", bray_var[2], "%)")
) +
theme_bw(base_size = 14) +
theme(legend.title = element_blank())
# Jaccard PCoA
p_jaccard_plot <- ggplot(jaccard_scores, aes(x = Axis1, y = Axis2, color = .data[[variable]])) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(
aes(group = .data[[variable]]),
geom = "path",
linetype = "dotted",
linewidth = 1,
alpha = 0.9,
type = "t",
level = 0.95
) +
labs(
title = paste(variable, "(Jaccard)"),
subtitle = p_text_jaccard,
x = paste0("PCoA1 (", jaccard_var[1], "%)"),
y = paste0("PCoA2 (", jaccard_var[2], "%)")
) +
theme_bw(base_size = 14) +
theme(legend.title = element_blank())
combined <- p_jaccard_plot + p_bray_plot
ggsave(
filename = paste0(variable, "_metabolite_pcoa.png"),
plot = combined,
width = 12, height = 6, dpi = 300
)
combined
}
# -------------------------------------------------------------------------
# Run plots for significant variables
# -------------------------------------------------------------------------
setwd("C:/Users/12697/Documents/MATH481_Max_Alta/Figures/Beta Diversity/Metabolome")
for (var in sig_vars) {
create_pcoa_plot(var, bray_scores, jaccard_scores)
}
View(food)
i = 22
variable = bdiv$variable[i]
bray_formula <- as.formula(paste("bray ~ calories_group + ", variable, sep = ""))
permanova_bray <- vegan::adonis2(bray_formula, data = food, by = "margin")
bdiv$bray_p[i] <- permanova_bray$`Pr(>F)`[2]
View(permanova_bray)
View(bdiv)
p_bray <- bdiv$bray_p[which(bdiv$variable == variable)]
p_jaccard <- bdiv$jaccard_p[which(bdiv$variable == variable)]
# -------------------------------------------------------------------------
# Function for plotting ordination with 95% ellipses
# -------------------------------------------------------------------------
create_pcoa_plot <- function(variable, bray_scores, jaccard_scores) {
# Force factor for grouping
bray_scores[[variable]] <- as.factor(bray_scores[[variable]])
jaccard_scores[[variable]] <- as.factor(jaccard_scores[[variable]])
p_bray <- bdiv$bray_p[which(bdiv$variable == variable)]
p_jaccard <- bdiv$jaccard_p[which(bdiv$variable == variable)]
p_text_bray <- ifelse(p_bray < 0.001, "p < 0.001", paste0("p = ", signif(p_bray, 3)))
p_text_jaccard <- ifelse(p_jaccard < 0.001, "p < 0.001", paste0("p = ", signif(p_jaccard, 3)))
# Bray–Curtis PCoA
p_bray_plot <- ggplot(bray_scores, aes(x = Axis1, y = Axis2, color = .data[[variable]])) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(
aes(group = .data[[variable]]),
geom = "path",
linetype = "dotted",
linewidth = 1,
alpha = 0.9,
type = "t",
level = 0.95
) +
labs(
title = paste(variable, "(Bray–Curtis)"),
subtitle = p_text_bray,
x = paste0("PCoA1 (", bray_var[1], "%)"),
y = paste0("PCoA2 (", bray_var[2], "%)")
) +
theme_bw(base_size = 14) +
theme(legend.title = element_blank())
# Jaccard PCoA
p_jaccard_plot <- ggplot(jaccard_scores, aes(x = Axis1, y = Axis2, color = .data[[variable]])) +
geom_point(size = 3, alpha = 0.8) +
stat_ellipse(
aes(group = .data[[variable]]),
geom = "path",
linetype = "dotted",
linewidth = 1,
alpha = 0.9,
type = "t",
level = 0.95
) +
labs(
title = paste(variable, "(Jaccard)"),
subtitle = p_text_jaccard,
x = paste0("PCoA1 (", jaccard_var[1], "%)"),
y = paste0("PCoA2 (", jaccard_var[2], "%)")
) +
theme_bw(base_size = 14) +
theme(legend.title = element_blank())
combined <- p_jaccard_plot + p_bray_plot
ggsave(
filename = paste0(variable, "_metabolite_pcoa.png"),
plot = combined,
width = 12, height = 6, dpi = 300
)
combined
}
# -------------------------------------------------------------------------
# Run plots for significant variables
# -------------------------------------------------------------------------
setwd("C:/Users/12697/Documents/MATH481_Max_Alta/Figures/Beta Diversity/Metabolome")
for (var in sig_vars) {
create_pcoa_plot(var, bray_scores, jaccard_scores)
}
library(BiocManager)
library(phyloseq)
library(tidyverse)
library(dplyr)
library(ggrepel)
library(patchwork)
library(RColorBrewer)
library(rlang)
library(MicrobiotaProcess)
library(vegan)
library(dplyr)
library(ALDEx2)
library(microbiomeMarker)
library(ggsci)
library(ggpubr)
library(patchwork)
library(tidyverse)
library(parallel)
library(doParallel)
library(pROC)
library(Maaslin2)
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis")
ps <- readRDS("categorized_data.RDS") # Load in using whatever file name you have
sam <- ps@sam_data
table(sam$Frequency_of_Using_School_Latrine)
108/(108+23+5)
cv_predict_clr_xgb <- function(
ps_obj,
outcome_var,
meta_cols,
min_prevalence = 0.05,
nfolds = 10,
seed = 100,
n_cores = 4
) {
set.seed(1313)
cl <- makeCluster(n_cores)
registerDoParallel(cl)
get_tax_matrix <- function(ps, taxlevel, prefix) {
ps_tax <- tax_glom(ps, taxlevel)
otumat <- as.data.frame(otu_table(ps_tax))
if (!taxa_are_rows(ps_tax)) otumat <- t(otumat)
taxmat <- as.data.frame(tax_table(ps_tax))
tax_names <- taxmat[[taxlevel]]
tax_names[is.na(tax_names) | tax_names == ""] <- "Unassigned"
rownames(otumat) <- paste0(prefix, make.unique(tax_names))
present_counts <- rowSums(otumat > 0)
keep <- present_counts >= (min_prevalence * ncol(otumat))
otumat <- otumat[keep, , drop = FALSE]
return(otumat)
}
fam_tab <- get_tax_matrix(ps_obj, "Family", "F__")
gen_tab <- get_tax_matrix(ps_obj, "Genus", "G__")
all_feat_tab <- rbind(fam_tab, gen_tab)
all_feat_tab[all_feat_tab == 0] <- 1e-6
clr_mat <- compositions::clr(all_feat_tab)
clr_mat <- t(clr_mat)
meta <- as.data.frame(sample_data(ps_obj))
clr_samples <- rownames(clr_mat)
meta <- meta[clr_samples, , drop = FALSE]
y <- as.factor(meta[[outcome_var]])
keep <- !is.na(y)
clr_mat <- clr_mat[keep, , drop = FALSE]
meta <- meta[keep, , drop = FALSE]
y <- y[keep]
levels(y) <- make.names(levels(y))
meta_cols <- intersect(meta_cols, colnames(meta))
meta_features <- meta[, meta_cols, drop = FALSE]
meta_features[] <- lapply(meta_features, function(x) as.numeric(as.character(x)))
meta_features <- meta_features[, sapply(meta_features, function(x) all(x %in% c(0, 1, NA))), drop = FALSE]
X_full <- cbind(clr_mat, meta_features)
nzv <- caret::nearZeroVar(X_full)
if (length(nzv) > 0) X_full <- X_full[, -nzv, drop = FALSE]
xgb_grid <- expand.grid(
nrounds = c(200, 400, 800),
max_depth = c(3, 5, 7, 9),
eta = c(0.01, 0.05, 0.1, 0.3),
gamma = c(0, 0.1, 0.5, 1),
colsample_bytree = c(0.6, 0.8, 1.0),
min_child_weight = c(1, 3, 5),
subsample = c(0.6, 0.8, 1.0)
)
fitControl <- caret::trainControl(
method = "cv",
number = nfolds,
classProbs = TRUE,
savePredictions = "final",
allowParallel = TRUE
)
xgb_fit <- caret::train(
x = X_full,
y = y,
method = "xgbTree",
tuneGrid = xgb_grid,
trControl = fitControl,
verbose = FALSE
)
overall_acc <- max(xgb_fit$results$Accuracy)
best_params <- xgb_fit$bestTune
varimp <- caret::varImp(xgb_fit, scale = FALSE)$importance
varimp_df <- tibble(Feature = rownames(varimp), Importance = varimp[,1]) %>%
arrange(desc(Importance)) %>%
mutate(Level = dplyr::case_when(
grepl("^F__", Feature) ~ "Family",
grepl("^G__", Feature) ~ "Genus",
Feature %in% meta_cols ~ "Metadata",
TRUE ~ "Other"
))
preds <- xgb_fit$pred$pred[order(xgb_fit$pred$rowIndex)]
y_true <- xgb_fit$pred$obs[order(xgb_fit$pred$rowIndex)]
overall_cm <- caret::confusionMatrix(preds, y_true)
stopCluster(cl)
registerDoSEQ()
return(list(
overall_accuracy = overall_acc,
best_params = best_params,
confusion_matrix = overall_cm,
feature_importance = varimp_df,
predictions = preds,
y_true = y_true,
xgb_fit = xgb_fit
))
}
plot_roc_curve_gg <- function(model_results, positive_class = NULL, factor) {
y_true <- model_results$y_true
if (is.null(positive_class)) {
positive_class <- levels(y_true)[1]
}
pred_prob <- model_results$xgb_fit$pred %>%
filter(obs %in% levels(y_true)) %>%
arrange(rowIndex) %>%
pull(!!as.name(positive_class))
roc_obj <- roc(y_true, pred_prob, levels = rev(levels(y_true)), direction = "<")
auc_value <- auc(roc_obj)
roc <- ggroc(roc_obj, legacy.axes = TRUE, colour = "darkgreen", size = 1.3) +
geom_abline(linetype = "dashed", color = "gray50") +
labs(
title = paste(gsub(pattern = "_", replacement = "", x = factor), ": ROC Curve (AUC = ", round(auc_value, 3), ")", sep = ""),
x = "False Positive Rate (1 - Specificity)",
y = "True Positive Rate (Sensitivity)"
) +
theme_minimal(base_size = 14)
ggsave(filename = paste(factor, "ROC.png", sep = ""), plot = roc, width = 8, height = 5)
}
plot_top_importance <- function(model_results, n_top = 10, bar_color = "#2c7bb6", factor) {
varimp <- model_results$feature_importance %>%
arrange(desc(Importance)) %>%
head(n_top)
plot <- ggplot(varimp, aes(x = reorder(Feature, Importance), y = Importance)) +
geom_bar(stat = "identity", fill = bar_color) +
coord_flip() +
labs(
title = paste(gsub(pattern = "_", replacement = "", x = factor), ": Top", n_top, "Feature Importance"),
x = "",
y = "Importance"
) +
theme_minimal(base_size = 14) +
theme(legend.position = "none")
ggsave(filename = paste(factor, "top_importance.png", sep = ""), plot = plot, width = 10, height = 5)
}
plot_top_feature_heatmap_clr <- function(
ps_obj,
model_results,
n_top = 10,
metadata_vars,
outcome_var,
min_prevalence = 0.05
) {
# 1. Top N features
top_features <- head(model_results$feature_importance$Feature, n_top)
# 2. Get genus & family tables
get_tax_matrix <- function(ps, taxlevel, prefix) {
ps_tax <- tax_glom(ps, taxlevel)
otumat <- as.data.frame(otu_table(ps_tax))
if (!taxa_are_rows(ps_tax)) otumat <- t(otumat)
taxmat <- as.data.frame(tax_table(ps_tax))
tax_names <- taxmat[[taxlevel]]
tax_names[is.na(tax_names) | tax_names == ""] <- "Unassigned"
rownames(otumat) <- paste0(prefix, make.unique(tax_names))
present_counts <- rowSums(otumat > 0)
keep <- present_counts >= (min_prevalence * ncol(otumat))
otumat <- otumat[keep, , drop=FALSE]
return(otumat)
}
fam_tab <- get_tax_matrix(ps_obj, "Family", "F__")
gen_tab <- get_tax_matrix(ps_obj, "Genus", "G__")
all_feat_tab <- rbind(fam_tab, gen_tab)
# 3. CLR transformation
all_feat_tab[all_feat_tab == 0] <- 1e-6
clr_mat <- compositions::clr(all_feat_tab)
clr_mat <- t(clr_mat)  # samples as rows, features as columns
# 4. Get metadata (as numeric)
meta <- as.data.frame(sample_data(ps_obj))
clr_samples <- rownames(clr_mat)
meta <- meta[clr_samples, , drop = FALSE]
metadata_vars <- intersect(metadata_vars, colnames(meta))
metadata_features <- meta[, metadata_vars, drop = FALSE]
metadata_features[] <- lapply(metadata_features, function(x) as.numeric(as.character(x)))
# 5. Combine CLR and metadata
X_full <- cbind(clr_mat, metadata_features)
# Ensure all columns are numeric
for (i in seq_len(ncol(X_full))) {
if (!is.numeric(X_full[, i])) {
X_full[, i] <- as.numeric(as.character(X_full[, i]))
}
}
# 6. Subset to top features, as rows (order preserved)
top_feats_present <- top_features[top_features %in% colnames(X_full)]
if (length(top_feats_present) == 0) stop("No top features found in input matrix.")
heatmap_mat <- t(X_full[, top_feats_present, drop = FALSE])
# Remove rows (features) that are all NA or all zero
keep_rows <- apply(heatmap_mat, 1, function(x) any(!is.na(x)) && any(x != 0))
heatmap_mat <- heatmap_mat[keep_rows, , drop = FALSE]
if (nrow(heatmap_mat) == 0) stop("No valid features to plot after removing all-NA/zero rows.")
# 7. Get annotation for sample outcome
sample_anno <- as(sample_data(ps_obj), "data.frame")[, outcome_var, drop = FALSE]
sample_anno <- sample_anno[colnames(heatmap_mat), , drop = FALSE]
sample_anno[[outcome_var]] <- as.factor(as.character(sample_anno[[outcome_var]]))
rownames(sample_anno) <- colnames(heatmap_mat)
# 8. Order columns by group
group_order <- order(sample_anno[[outcome_var]])
heatmap_mat <- heatmap_mat[, group_order, drop = FALSE]
sample_anno <- sample_anno[group_order, , drop = FALSE]
# 9. Z-score (standardize) each feature (row)
heatmap_mat_scaled <- t(scale(t(heatmap_mat)))
heatmap_mat_scaled[is.na(heatmap_mat_scaled)] <- 0
# 10. Plot heatmap (no clustering of samples)
heatmap <- pheatmap::pheatmap(
mat = heatmap_mat_scaled,
annotation_col = sample_anno,
main = paste("Top", n_top, "Features Heatmap"),
clustering_method = "complete",
cluster_cols = FALSE,
cluster_rows = TRUE,
fontsize_row = 10,
fontsize_col = 7,
scale = "none",
color = colorRampPalette(c("navy", "white", "firebrick3"))(100)
)
ggsave(filename = paste(outcome_var, "_heatmap.png", sep = ""), plot = heatmap, height = 6, width = 18)
return(heatmap)
}
# Use of School Latrine
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis")
ps <- readRDS("categorized_data.RDS")
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/Machine Learning/Heatmaps")
ps <- subset_samples(ps, Frequency_of_Using_School_Latrine %in% c("always", "never", "sometimes"))
ps@sam_data$Frequency_of_Using_School_Latrine <- ifelse(ps@sam_data$Frequency_of_Using_School_Latrine == "never", "never", "always/sometimes")
school_latrine_results <- cv_predict_clr_xgb(ps, "Frequency_of_Using_School_Latrine", meta_cols = c("Age", "Sex"))
setwd("C:/Users/12697/Documents/Microbiome/Data Analysis/Figures/Machine Learning")
save(school_latrine_results, file = "school_latrine_results.RData")
school_latrine_results$confusion_matrix
